# Northflank 部署流程 (单服务 + SupervisorD 模型)

本文档描述了在 Northflank 平台上，使用 **单服务 + SupervisorD** 模型部署 Xboard 应用的最终流程。此方案旨在解决 Northflank 存储卷无法在服务间共享的核心限制。

## 1. 部署架构概述

该部署配置包含一个核心服务和一个持久化存储方案：
1.  **单一服务 (`xboard`)**: 这是一个 `web` 类型的服务，其内部通过 SupervisorD 同时运行 **Web 进程** (`php artisan octane:start`) 和 **队列工作进程** (`php artisan queue:work`)。
2.  **持久化存储 (`xboard-data`)**: 一个由 Northflank 提供的存储卷，用于持久化 SQLite 数据库和所有应用数据（缓存、会话、日志等）。它将被挂载到 `xboard` 服务的 `/app/storage` 目录。

此架构通过在单个容器内运行所有进程，完美地解决了多个进程需要访问同一个 SQLite 数据库文件的问题。

---

## 2. 详细部署步骤

您可以通过 Northflank 的 UI 或 CLI，使用项目中的 `northflank.yml` 文件来创建和部署服务。以下是该文件定义的工作流程：

### 步骤一：创建 Add-ons

Northflank 会首先根据 `northflank.yml` 的 `addons` 部分创建所需的基础设施：
-   **`xboard-data`**: 一个持久化存储卷。

### 步骤二：构建服务 (`xboard`)

接下来，Northflank 会开始构建 `xboard` 服务。
1.  **构建 Docker 镜像**:
    -   使用项目根目录下的 `Dockerfile`。
    -   这个 `Dockerfile` 会安装所有必要的 PHP 扩展和 `supervisor`。
    -   它会将项目代码复制到镜像中，并设置 SupervisorD 作为容器的启动命令 (`CMD`)。
2.  **执行构建时命令 (Build Steps)**:
    -   在镜像构建完成后，但在服务启动前，Northflank 会在容器内按顺序执行 `northflank.yml` 中定义的 `build` 命令。这是应用初始化的关键步骤：
        1.  `mkdir -p /app/storage/database && touch /app/storage/database/database.sqlite`: 在挂载的存储卷内创建用于存放数据库的子目录和空的 SQLite 文件。
        2.  `composer install --no-dev --optimize-autoloader`: 安装生产环境所需的 PHP 依赖。
        3.  `php artisan cache:table`: **创建缓存表所需的迁移文件**。这是 `database` 缓存驱动所必需的。
        4.  `php artisan migrate --force`: 运行所有数据库迁移，包括刚刚创建的 `cache` 表迁移，在 SQLite 文件中创建所有数据表结构。
        5.  `php artisan xboard:install`: 执行 Xboard 的安装脚本，进行初始化设置。
        6.  `php artisan optimize:clear`: **彻底清除所有应用缓存**，以确保旧的（如 Horizon 的）配置不会导致应用崩溃。

### 步骤三：启动服务

1.  **启动容器**: Northflank 启动构建好的容器。
2.  **运行 SupervisorD**: 容器的启动命令是 `supervisord`。
3.  **启动子进程**: SupervisorD 会根据 `.docker/supervisor/supervisord.conf` 文件的配置，启动并监控两个后台进程：
    -   `php artisan octane:start --host=0.0.0.0 --port=7002` (Web 进程)
    -   `php artisan queue:work --tries=3 --timeout=1800` (队列工作进程)

---

## 3. 如何部署

1.  **将代码推送到您的 Git 仓库** (例如 GitHub)。
2.  **在 Northflank 上创建一个新项目**。
3.  **选择 "Create a new service"**，然后选择从 Git 仓库导入。
4.  **指向您的仓库和分支**，Northflank 会自动检测到 `northflank.yml` 文件。
5.  **确认计划**: Northflank 会展示它将要创建的服务 (`xboard`) 和插件 (`xboard-data`)。
6.  **点击 "Create service"**。

Northflank 将会自动执行上述所有构建和启动步骤。部署完成后，您可以通过 Northflank 提供的 URL 访问您的应用。

---

## 4. 重要提示：关于手动创建 Addon

**您不需要手动创建任何 Addon！**

我们提供的 `northflank.yml` 文件已经完整定义了所有需要的服务和插件。最佳的部署方式是让 Northflank 自动读取此文件并为您创建所有资源。

如果您确实需要手动创建，请注意：
- 您在截图中展示的界面是用于创建**数据库插件**（如 Redis, MySQL）的。**请不要选择其中任何一项**。
- 我们的项目需要的是 **持久化存储 (Persistent Storage)** 类型的插件，它在 Northflank 中通常被归类为 "Storage"。请确保您选择了正确的类型，否则部署将会失败。
