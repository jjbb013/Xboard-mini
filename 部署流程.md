# Northflank 部署流程 (最终版)

本文档是部署 Xboard 应用到 Northflank 平台的最终、最详细的操作指南。请严格按照此流程操作，以确保部署成功。

## 1. 核心部署策略

我们采用 **单服务 + SupervisorD + Entrypoint 脚本** 的模型。`northflank.yml` 文件定义了基础服务，但关键的 **网络、存储和环境变量** 需要您在 Northflank 平台上手动配置，以确保灵活性和控制力。

---

## 2. 部署前的唯一前提

确保我们所有的最新代码修改（包括 `PROJECT.md`, `Dockerfile`, `northflank.yml`, `entrypoint.sh` 等）都已推送到您的 GitHub 仓库的 `master` 分支。

---

## 3. 详细部署操作步骤

### 步骤一：删除旧的、失败的服务

为了避免任何缓存或旧配置的干扰，请**首先在您的 Northflank 项目中，彻底删除之前创建的、所有失败的服务和插件（包括存储卷）**。我们需要从一个完全干净的状态开始。

### 步骤二：从 Git 仓库创建新服务

1.  在您的 Northflank 项目中，点击 **"Create new service"**。
2.  选择 **"Repository"** 方式。
3.  选择您的 GitHub 账户，并选择 `jjbb013/Xboard-mini` 仓库。
4.  选择 `master` 分支。

### 步骤三：手动配置服务

Northflank 会部分解析 `northflank.yml` 文件，并展示一个配置表单让您补充和确认。请按照以下说明完成手动配置：

#### 1. 服务配置 (Service)

-   **Service Name**: 可以保持 `xboard` 或自定义。
-   **Type**: 确保是 `web`。

#### 2. 网络配置 (Networking)

-   在 **Ports** 部分，点击 **"Add port"**。
-   **Port**: 输入 `8080` (这是我们 `Dockerfile` 中暴露的端口)。
-   **Protocol**: **必须选择 `HTTP`**。这是确保服务能被公网访问的关键。
-   **Public**: 确保开关是打开的。

#### 3. 环境变量配置 (Environment)

-   **重要**：您需要手动设置所有环境变量。如果您使用 Northflank 的 MySQL 插件，平台会自动提供以下变量：
    - `NF_MYSQL_HOST`
    - `NF_MYSQL_DATABASE`
    - `NF_MYSQL_USERNAME`
    - `NF_MYSQL_PASSWORD`

    在这种情况下，您只需要添加以下环境变量：

    ```
    APP_NAME=XBoard
    APP_ENV=production
    APP_DEBUG=false
    APP_URL=http://localhost
    
    LOG_CHANNEL=stack
    
    DB_CONNECTION=mysql
    DB_PORT=3306
    DB_SSL_VERIFY_SERVER_CERT=true
    
    BROADCAST_DRIVER=log
    CACHE_DRIVER=database
    QUEUE_CONNECTION=database
    SESSION_DRIVER=database
    
    MAIL_DRIVER=smtp
    MAIL_HOST=smtp.mailtrap.io
    MAIL_PORT=2525
    MAIL_USERNAME=null
    MAIL_PASSWORD=null
    MAIL_ENCRYPTION=null
    MAIL_FROM_ADDRESS=null
    MAIL_FROM_NAME=null
    
    ADMIN_EMAIL=your_admin_email@example.com
    ADMIN_PASSWORD=your_secure_password
    ```

-   **重要：单独添加 APP_KEY**
    -   完成批量添加后，返回环境变量配置界面。
    -   点击 **"Add secret"** 或 **"Add new secret"**。
    -   **Key**: `APP_KEY`
    -   **Value**: 您需要手动设置此值，可以：
        - 使用命令 `php artisan key:generate --show` 生成密钥，或
        - 创建您自己的32位随机字符串，并添加前缀 `base64:`（例如：`base64:your-32-char-random-string-here`）

#### 4. 存储卷配置 (Volumes)

-   在 **Volumes** 部分，点击 **"Add volume"**。
-   **Mount path**: 输入 `/www/storage` (这是我们 `Dockerfile` 的工作目录下的 `storage` 目录)。
-   **Volume name**: 输入 `xboard-data` (或您喜欢的任何名称)。
-   **Storage size**: 根据需要选择，免费套餐通常有额度。

### 步骤四：启动部署

完成并仔细检查上述所有手动配置后，点击页面底部的 **"Create service"** 或 **"Deploy"** 按钮。

Northflank 将会使用 `Dockerfile` 构建镜像，并结合您手动配置的参数来启动服务。部署完成后，`entrypoint.sh` 脚本会自动完成应用初始化，您应该能通过 Northflank 提供的公开域名访问您的网站。
