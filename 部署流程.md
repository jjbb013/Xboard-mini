# Northflank 部署流程

本文档根据 `northflank.yml` 文件内容，描述了在 Northflank 平台上部署 Xboard 应用的流程。

## 概述

该部署配置包含两个核心服务和一个持久化存储方案：
1.  **Web 服务 (`xboard-web`)**: 运行主应用程序，处理用户请求。
2.  **队列工作进程 (`xboard-queue`)**: 在后台处理耗时任务（如发送邮件、统计等）。
3.  **持久化存储 (`addons`)**: 使用 Northflank 的存储服务来持久化 SQLite 数据库和应用数据。

---

## 1. 持久化存储配置

为了兼容 Northflank 的免费计划，我们使用单个持久化存储卷来存放所有需要持久化的数据。

-   **`xboard-data`**: 这是一个由 Northflank 提供的存储卷，用于存放 SQLite 数据库、缓存文件、会话、日志等所有应用数据。

这个存储卷会被挂载到 Web 服务和队列工作进程的 `/app/storage` 目录。通过将数据库也存放在这个目录的子文件夹中，我们实现了单卷管理所有持久化数据。

---

## 2. Web 服务 (`xboard-web`)

这是应用程序的主要服务，负责对外提供 Web 访问。

### 构建步骤

在容器启动前，会执行以下构建命令：
1.  `mkdir -p /app/storage/database && touch /app/storage/database/database.sqlite`: 在挂载的存储卷内创建用于存放数据库的子目录，并创建空的 SQLite 文件。
2.  `composer install --no-dev --optimize-autoloader`: 安装生产环境所需的 PHP 依赖。
3.  `php artisan migrate --force`: 运行数据库迁移，在 SQLite 文件中创建数据表结构。
4.  `php artisan xboard:install`: 执行 Xboard 的安装脚本，进行初始化设置。

### 环境变量

Web 服务配置了以下关键环境变量：
-   `APP_ENV`: `production` (生产模式)
-   `APP_DEBUG`: `false` (关闭调试模式)
-   `APP_KEY`: 自动生成一个唯一的应用密钥。
-   `DB_CONNECTION`: `sqlite` (指定使用 SQLite 数据库)。
-   `DB_DATABASE`: `/app/storage/database/database.sqlite` (指定 SQLite 数据库文件的绝对路径，该文件位于持久化存储卷中)。
-   `CACHE_DRIVER`, `SESSION_DRIVER`: 设置为 `file`，将缓存和会话数据存储在挂载的 `/app/storage` 目录中。
-   `QUEUE_CONNECTION`: 设置为 `database`，队列任务信息仍存储在 SQLite 数据库中。

### 启动命令

容器启动后，将执行以下命令来运行应用：
-   `php artisan octane:start --host=0.0.0.0 --port=7002`: 使用 Octane 启动应用，监听在 `7002` 端口。

---

## 3. 队列工作进程 (`xboard-queue`)

此服务负责在后台异步处理任务，以提高应用的响应速度。

### 构建步骤

1.  `composer install --no-dev --optimize-autoloader`: 与 Web 服务一样，安装生产环境的 PHP 依赖。

### 环境变量

队列工作进程的环境变量与 Web 服务基本一致，以确保它能连接到同一个 SQLite 数据库并使用相同的应用配置。
-   `APP_KEY`: 从 `xboard-web` 服务获取，确保两个服务使用相同的密钥。
-   `DB_CONNECTION`: `sqlite`
-   `DB_DATABASE`: `/app/storage/database/database.sqlite`
-   `CACHE_DRIVER`, `SESSION_DRIVER`: `file`

### 启动命令

容器启动后，将执行以下命令来处理队列任务：
-   `php artisan queue:work --tries=3 --timeout=1800`: 启动队列工作进程，每个任务最多尝试 3 次，超时时间为 1800 秒 (30分钟)。

---

## 总结

整个部署流程是自动化的：
1.  Northflank 首先创建名为 `xboard-data` 的单个持久化存储卷。
2.  然后并行构建 `xboard-web` 和 `xboard-queue` 服务，并将 `xboard-data` 存储卷挂载到两个服务的 `/app/storage` 目录。
3.  在 `xboard-web` 服务的构建过程中，完成数据库文件创建、依赖安装、数据库迁移和应用安装。所有持久化数据（数据库、缓存、日志等）都将写入此共享存储卷。
4.  最后，启动 Web 服务和队列工作进程，应用开始正常运行。
