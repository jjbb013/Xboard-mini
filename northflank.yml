version: '2'
services:
  # Single service for both Web and Queue Worker, managed by SupervisorD
  - name: xboard
    type: web
    provider: docker
    dockerfile: Dockerfile
    ports:
      - port: 7002
        protocol: HTTP
    env:
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: false
      - key: APP_KEY
        generate: secret-key
      - key: DB_CONNECTION
        value: sqlite
      - key: DB_DATABASE
        value: /app/storage/database/database.sqlite
      - key: CACHE_DRIVER
        value: database
      - key: SESSION_DRIVER
        value: database
      - key: QUEUE_CONNECTION
        value: database
    build:
      - command: mkdir -p /app/storage/database && touch /app/storage/database/database.sqlite
      - command: php artisan cache:table
      - command: php artisan migrate --force
      - command: php artisan xboard:install
      - command: php artisan optimize:clear
    volumes:
      - name: xboard-data
        path: /app/storage

addons:
  # Persistent Storage for SQLite DB, file cache, etc.
  - name: xboard-data
    type: storage
    provider: northflank
