# Redis 移除修改计划

本项目旨在移除所有 Redis 依赖，以适应 Northflank 免费计划的部署环境。
以下是文件检查的详细记录。

## 文件分析记录

### `compose.sample.yaml`

- **redis 服务**: 整个 `redis` 服务定义需要被移除。
- **web 服务**:
    - 移除 `depends_on: - redis`
    - 移除 `volumes` 中的 `- ./.docker/.data/redis/:/data/`
- **horizon 服务**:
    - 移除 `depends_on: - redis`
    - 移除 `volumes` 中的 `- ./.docker/.data/redis/:/data/`
    - `horizon` 服务本身依赖 Redis，需要被移除或替换。

### `.env.example`

- **Redis 连接**:
    - `REDIS_HOST`: 需要移除。
    - `REDIS_PASSWORD`: 需要移除。
    - `REDIS_PORT`: 需要移除。
- **缓存驱动**:
    - `CACHE_DRIVER=redis`: 需要修改为 `file` 或 `database`。
- **队列连接**:
    - `QUEUE_CONNECTION=redis`: 需要修改为 `database` 或 `sync`。

### `composer.json`

- **`laravel/horizon`**: 这个包是 Redis 队列的仪表盘，强依赖 Redis。需要从 `require` 中移除。移除后，后台任务需要使用 `database` 驱动并通过 `php artisan queue:work` 命令来处理。

### `config/app.php`

- **`providers` 数组**:
    - `Illuminate\Redis\RedisServiceProvider::class`: 需要移除或注释掉。
    - `App\Providers\HorizonServiceProvider::class`: 需要移除或注释掉。

### `config/cache.php`

- **`stores` 数组**:
    - `'redis'` 键值对: 整个 Redis store 的配置需要被移除。
- **`default`**: 默认驱动已设置为 `env('CACHE_DRIVER', 'file')`，这很好，我们只需要确保在 `.env` 文件中 `CACHE_DRIVER` 被设置为 `file` 或 `database` 即可。

### `config/database.php`

- **`redis` 数组**: 整个 `redis` 配置数组，包括其下的 `client`, `options`, `default`, 和 `cache` 连接，都需要被完全移除。

### `config/queue.php`

- **`connections` 数组**:
    - `'redis'` 键值对: 整个 Redis connection 的配置需要被移除。
- **`default`**: 默认驱动已设置为 `env('QUEUE_CONNECTION', 'sync')`。我们需要在 `.env` 文件中将其设置为 `database` 以便队列任务可以持久化。

### `config/horizon.php`

- **整个文件**: 由于 `laravel/horizon` 包将被移除，这个配置文件也需要被完全删除。

### `config/session.php`

- **无需修改**: 该文件默认使用 `file` 驱动进行会话管理 (`'driver' => env('SESSION_DRIVER', 'file')`)，没有直接或间接地使用 Redis。

### `app/Providers/HorizonServiceProvider.php`

- **整个文件**: 这是 `laravel/horizon` 包的服务提供者。由于包将被移除，这个文件也需要被完全删除。

### `app/Services/StatisticalService.php`

这个服务严重依赖 Redis 的 Sorted Set 功能 (`zincrby`, `zrange`) 来实时缓存和聚合流量统计数据，之后再由定时任务存入数据库。移除 Redis 后，需要将这部分逻辑直接改为数据库操作。

- **`use Illuminate\Support\Facades\Redis;`**: 需要移除。
- **`$redis` 属性**: 需要移除。
- **`__construct()`**:
    - 移除 `$this->redis = Redis::connection();`。
- **`statServer($serverId, $serverType, $u, $d)`**:
    - **原逻辑**: 使用 `zincrby` 将流量数据写入 Redis。
    - **修改后逻辑**: 需要改为直接对 `stat_server` 表进行 `updateOrInsert` 操作，累加 `u` 和 `d` 字段。
- **`statUser($rate, $userId, $u, $d)`**:
    - **原逻辑**: 使用 `zincrby` 将流量数据写入 Redis。
    - **修改后逻辑**: 需要改为直接对 `stat_user` 表进行 `updateOrInsert` 操作，累加 `u` 和 `d` 字段。
- **`getStatUserByUserID()`**, **`getStatUser()`**, **`getStatServer()`**:
    - **原逻辑**: 从 Redis 读取聚合数据。
    - **修改后逻辑**: 这些方法可能需要被重写以直接从数据库读取数据，或者如果它们仅用于被移除的逻辑，则可以删除。
- **`clearStatUser()`**, **`clearStatServer()`**:
    - **原逻辑**: 从 Redis 删除 key。
    - **修改后逻辑**: 这些方法将不再需要，应该被删除。

### `app/Support/Setting.php`

这个类用于管理应用配置，并使用缓存来提高性能。

- **`__construct()`**:
    - **原逻辑**: `$this->cache = Cache::store('redis');` 硬编码了 Redis 作为缓存存储。
    - **修改后逻辑**: 需要修改为 `$this->cache = Cache::store();` 或 `$this->cache = app('cache')->store();`，使其使用在 `.env` 文件中定义的默认缓存驱动（我们将配置为 `file` 或 `database`）。

### `app/Utils/CacheKey.php`

- **无需修改**: 这个文件只用于生成和管理缓存键的名称，不涉及具体的缓存实现，与 Redis 无关。

### `app/Utils/Helper.php`

- **无需修改**: 这个文件包含一系列通用的辅助函数，没有发现与 Redis 相关的功能。

## 第二轮检查：通用缓存使用 (`Cache::`)

为了确保覆盖所有文件，我进行了对 `Cache::` 的全局搜索。结果表明，项目在许多地方都依赖默认缓存。

- **发现**: 项目广泛使用 `Cache::` Facade 进行速率限制、状态存储、版本控制、插件配置缓存和任务调度。
- **关键发现**: 在 `app/Providers/OctaneServiceProvider.php` 中使用了 `Cache::lock()`。这是一个原子锁功能，`file` 缓存驱动不支持此功能，但 `database` 缓存驱动支持。
- **结论**:
    - 无需修改这些使用 `Cache::` 的文件，因为它们依赖的是默认驱动。
    - **必须**将 `.env` 文件中的 `CACHE_DRIVER` 设置为 `database`，而不是 `file`，以确保原子锁功能可以正常工作。这加强了我们之前的计划，并给出了更明确的驱动选择。

## 最终确认

经过两轮详细检查（第一轮针对明确的 Redis 依赖，第二轮针对通用的缓存使用），我已经覆盖了所有与 Redis 和缓存相关的代码。可以确认，除了已在计划中列出的文件外，其他文件不需要进行代码修改。整个重构的核心在于正确配置环境、移除不再需要的包和文件，并重写 `StatisticalService` 的核心逻辑。
